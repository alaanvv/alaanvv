#!/usr/bin/env bash

if ! [ -f "$1" ]; then
	exit 1
fi

cache="$HOME/.cache/vidthumb"
index="$cache/index.json"
movie="$(realpath "$1")"

mkdir -p "$cache"

if [ -f "$index" ]; then
	thumbnail="$(jq -r ". \"$movie\"" <"$index")"
	if [[ "$thumbnail" != "null" ]]; then
		if [[ -f "$cache/$thumbnail" ]]; then
			echo "$cache/$thumbnail"
			exit 0
		fi
	fi
fi

thumbnail="$(uuidgen).jpg"

if ! ffmpeg -y -ss 00:00:01 -i "$movie" -vframes 1 -q:v 2 "$cache/$thumbnail" >/dev/null 2>&1; then
	exit 1
fi

if [[ ! -f "$index" ]]; then
	echo "{\"$movie\": \"$thumbnail\"}" >"$index"
else
	jq --arg movie "$movie" --arg thumb "$thumbnail" '. + {($movie): $thumb}' "$index" >"$index.tmp" && mv "$index.tmp" "$index"
fi

echo "$cache/$thumbnail"

